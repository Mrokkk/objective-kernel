#!/bin/bash

set -e

qemu=$(which qemu-system-i386 2>/dev/null || which qemu-system-x86_64 2>/dev/null)

if [[ "${qemu}" == "" ]]; then
    echo "No QEMU found!"
    exit 1
fi

rm -rf log

for image in images/*.iso; do
    ${qemu} -cdrom ${image} -display none -serial stdio -no-reboot -cpu core2duo $@ 2>>log | sed '/.*Booting/d' | tee -a log | grep "RUN\|PASS\|FAIL\|failed\|WARNING"
done

if grep -q "FAIL\|error" log; then
    exit 1
fi

